<script type="module">
  // =========================
  // ‚úÖ Firebase (Local + Cloud)
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖÿ¥ÿ±ŸàÿπŸÉ (ŸÜŸÅÿ≥ ÿßŸÑŸÑŸä ÿØÿ≤ŸëŸäÿ™Ÿá)
  const firebaseConfig = {
    apiKey: "AIzaSyC4Q4qTILDP4eYuo8OpER_NQ4udj5lXSwM",
    authDomain: "nabeel-abd.firebaseapp.com",
    projectId: "nabeel-abd",
    storageBucket: "nabeel-abd.firebasestorage.app",
    messagingSenderId: "397355019788",
    appId: "1:397355019788:web:9d1961a81f62d06f44c829",
    measurementId: "G-9ES5BKWRVH"
  };

  const appFB = initializeApp(firebaseConfig);
  const auth = getAuth(appFB);
  const db = getFirestore(appFB);

  // =========================
  // ‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇŸÉ ÿßŸÑÿ£ÿµŸÑŸä (ŸÖÿπ Cloud Sync)
  // =========================
  (function () {
    const stockCountEl = document.getElementById('stockCount');
    const pulledCountEl = document.getElementById('pulledCount');
    const titleNameEl = document.getElementById('titleName');

    const tabsWrap = document.getElementById('tabsWrap');
    const addInvBtn = document.getElementById('addInvBtn');
    const settingsBtn = document.getElementById('settingsBtn');

    const linksBtn = document.getElementById('linksBtn');
    const linksModal = document.getElementById('linksModal');
    const closeLinksBtn = document.getElementById('closeLinksBtn');
    const addLinkBtn = document.getElementById('addLinkBtn');
    const linksWrap = document.getElementById('linksWrap');

    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const invListWrap = document.getElementById('invListWrap');

    const inputSectionEl = document.getElementById('inputSection');
    const bulkInputEl = document.getElementById('bulkInput');

    const resultAreaEl = document.getElementById('resultArea');
    const timestampEl = document.getElementById('timestamp');

    const emailDisplayEl = document.getElementById('emailDisplay');
    const passDisplayEl = document.getElementById('passDisplay');
    const recDisplayEl = document.getElementById('recDisplay');
    const urlBtnEl = document.getElementById('urlBtn');

    const toggleBtn = document.getElementById('toggleBtn');
    const clearBtn = document.getElementById('clearBtn');
    const addBtn = document.getElementById('addBtn');
    const pullBtn = document.getElementById('pullBtn');
    const copyFullBtn = document.getElementById('copyFullBtn');

    const restoreBtn = document.getElementById('restoreBtn');
    const deleteLastBtn = document.getElementById('deleteLastBtn');

    const moveButtonsWrap = document.getElementById('moveButtonsWrap');

    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const exportBtn = document.getElementById('exportBtn');

    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastIcon = document.getElementById('toastIcon');
    let toastTimeout;

    // ===== Inventories =====
    const META_KEY = 'smartInv_inventories_meta_v1';
    const ACTIVE_KEY = 'smartInv_activeInventory_v1';

    // Go ŸáŸà ŸÜŸÅÿ≥ ŸÖŸÅÿßÿ™Ÿäÿ≠ Gemini ÿßŸÑŸÇÿØŸäŸÖÿ© (ÿ≠ÿ™Ÿâ ŸÑÿß ÿ™ÿ∂Ÿäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ)
    const GO_ID = 'gemini';
    const NEW_GEMINI_ID = 'gemini_new';

    const LEGACY_KEYS = {
      main:   { data:'smartInventory_data', pulled:'smartInventory_pulled', last:'smartInventory_lastPulled', undo:'smartInventory_undo' },
      gemini: { data:'smartGemini_data',    pulled:'smartGemini_pulled',   last:'smartGemini_lastPulled',   undo:'smartGemini_undo' }
    };

    let inventoriesMeta = [];
    let activeInvId = 'main';
    let store = {};

    // Links
    const LINKS_KEY = 'smartInv_quickLinks_v2';
    let quickLinks = [];

    function safeJsonParse(value, fallback) { try { return JSON.parse(value); } catch { return fallback; } }

    function flash(el){
      if(!el) return;
      el.classList.remove('flash');
      void el.offsetWidth;
      el.classList.add('flash');
      setTimeout(()=> el.classList.remove('flash'), 260);
    }

    function showToast(message, type = 'info') {
      toastMsg.textContent = message;
      toast.className =
        "fixed bottom-5 left-5 px-5 py-3 rounded-2xl shadow-2xl transform transition-all duration-300 z-50 flex items-center gap-3 font-bold border";

      if (type === 'success') {
        toast.classList.add('bg-emerald-950/80', 'border-emerald-800/60', 'text-emerald-100');
        toastIcon.className = "fa-solid fa-circle-check text-emerald-300";
      } else if (type === 'error') {
        toast.classList.add('bg-red-950/80', 'border-red-800/60', 'text-red-100');
        toastIcon.className = "fa-solid fa-triangle-exclamation text-red-300";
      } else if (type === 'copy') {
        toast.classList.add('bg-blue-950/80', 'border-blue-800/60', 'text-blue-100');
        toastIcon.className = "fa-solid fa-copy text-blue-300";
      } else {
        toast.classList.add('bg-slate-900/90', 'border-slate-700/70', 'text-white');
        toastIcon.className = "fa-solid fa-info-circle text-slate-200";
      }

      toast.classList.remove('translate-y-20', 'opacity-0');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 2300);
    }

    async function copyText(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (_) {}
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch (_) { return false; }
    }

    function normalizeUrl(u){
      const url = String(u || '').trim();
      if(!url) return '';
      if (!/^https?:\/\//i.test(url)) return 'https://' + url;
      return url;
    }

    function getInvMetaById(id){ return inventoriesMeta.find(x => x.id === id) || null; }

    function keysFor(id){
      const meta = getInvMetaById(id);
      if (!meta) return LEGACY_KEYS.main;
      if (meta.type === 'legacy-main') return LEGACY_KEYS.main;
      if (meta.type === 'legacy-gemini') return LEGACY_KEYS.gemini;

      const p = `smartInv_${meta.id}`;
      return {
        data:   `${p}_data`,
        pulled: `${p}_pulled`,
        last:   `${p}_lastPulled`,
        undo:   `${p}_undo`
      };
    }

    function K(){ return keysFor(activeInvId); }
    function S(){
      if(!store[activeInvId]) store[activeInvId] = { inventory: [], pulledCounter: 0, currentAccount: null };
      return store[activeInvId];
    }

    // =========================
    // ‚úÖ CLOUD SYNC (ÿ≥ÿ≠ÿßÿ®Ÿä + ŸÖÿ≠ŸÑŸä)
    // =========================
    const CLOUD = {
      uid: null,
      email: null,
      docRef: null,
      unsub: null,
      ready: false,
      lastLocalWrite: 0,
      debounceT: null
    };

    function cloudDoc(){
      if(!CLOUD.uid) return null;
      return doc(db, "users", CLOUD.uid, "smartInv", "state");
    }

    function buildCloudPayload(){
      // ÿÆÿ≤ŸëŸÜ ŸÉŸÑ ÿßŸÑŸÖÿÆÿßÿ≤ŸÜ (ŸÉŸÑ inv)
      const allStores = {};
      for (const inv of inventoriesMeta) {
        const id = inv.id;
        if(!store[id]) store[id] = { inventory: [], pulledCounter: 0, currentAccount: null };

        // ÿ™ÿ£ŸÉÿØ ŸÖÿ≠ŸÖŸëŸÑ ŸÖŸÜ localStorage
        const prev = activeInvId;
        activeInvId = id;
        loadActive();
        activeInvId = prev;

        allStores[id] = {
          inventory: store[id].inventory || [],
          pulledCounter: Number(store[id].pulledCounter || 0),
          currentAccount: store[id].currentAccount || null
        };
      }

      return {
        v: 1,
        updatedAt: Date.now(),
        meta: inventoriesMeta,
        activeInvId,
        stores: allStores,
        links: quickLinks
      };
    }

    function applyCloudPayload(payload){
      try{
        if(!payload) return;

        // ‚úÖ Meta + Active
        if (payload.meta) localStorage.setItem(META_KEY, JSON.stringify(payload.meta));
        if (payload.activeInvId) localStorage.setItem(ACTIVE_KEY, payload.activeInvId);

        // ‚úÖ Links
        if (payload.links) localStorage.setItem(LINKS_KEY, JSON.stringify(payload.links));

        // ‚úÖ Stores per inventory -> ŸÜŸÅÿ≥ ŸÖŸÅÿßÿ™Ÿäÿ≠ localStorage
        const metaArr = payload.meta || safeJsonParse(localStorage.getItem(META_KEY), []) || [];
        const storesObj = payload.stores || {};

        for (const inv of metaArr) {
          const id = inv.id;
          const keys = (function(){
            if (inv.type === 'legacy-main') return LEGACY_KEYS.main;
            if (inv.type === 'legacy-gemini') return LEGACY_KEYS.gemini;
            const p = `smartInv_${id}`;
            return { data:`${p}_data`, pulled:`${p}_pulled`, last:`${p}_lastPulled`, undo:`${p}_undo` };
          })();

          const s = storesObj[id];
          if (!s) continue;

          localStorage.setItem(keys.data, JSON.stringify(s.inventory || []));
          localStorage.setItem(keys.pulled, String(s.pulledCounter || 0));

          if (s.currentAccount) localStorage.setItem(keys.last, JSON.stringify(s.currentAccount));
          else localStorage.removeItem(keys.last);
        }
      }catch(e){
        console.error(e);
      }
    }

    async function cloudSaveAll(force=false){
      if(!CLOUD.uid) return;
      const d = cloudDoc();
      if(!d) return;

      const payload = buildCloudPayload();
      CLOUD.lastLocalWrite = payload.updatedAt;

      try{
        await setDoc(d, payload, { merge: false });
        if(force) showToast("‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≥ÿ≠ÿßÿ®ŸäÿßŸã", "success");
      }catch(e){
        console.error(e);
        showToast("‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä (ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firestore Rules)", "error");
      }
    }

    function cloudSaveDebounced(){
      if(!CLOUD.uid) return;
      clearTimeout(CLOUD.debounceT);
      CLOUD.debounceT = setTimeout(()=> cloudSaveAll(false), 800);
    }

    async function cloudLoadOnce(){
      if(!CLOUD.uid) return;
      const d = cloudDoc();
      if(!d) return;

      try{
        const snap = await getDoc(d);
        if(snap.exists()){
          const data = snap.data();
          // ‚úÖ ÿ•ÿ∞ÿß ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÅŸäŸáÿß ÿ®ŸäÿßŸÜÿßÿ™ÿå ÿÆÿ∞Ÿáÿß ŸàÿÆÿ≤ŸÜŸáÿß ŸÖÿ≠ŸÑŸäÿßŸã
          applyCloudPayload(data);
          showToast("‚òÅÔ∏è ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©", "success");
          // ÿ£ÿ≥ŸáŸÑ ÿ∑ÿ±ŸäŸÇÿ© ŸÑÿ∂ŸÖÿßŸÜ ŸÉŸÑÿ¥Ÿä Ÿäÿ¥ÿ™ÿ∫ŸÑ: ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
          setTimeout(()=> location.reload(), 600);
        }else{
          // ‚úÖ ÿ£ŸàŸÑ ŸÖÿ±ÿ©: ÿßÿ±ŸÅÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÑŸÑÿ≥ÿ≠ÿßÿ®ÿ©
          await cloudSaveAll(true);
        }
      }catch(e){
        console.error(e);
        showToast("‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©", "error");
      }
    }

    function cloudListen(){
      if(!CLOUD.uid) return;
      const d = cloudDoc();
      if(!d) return;

      if(CLOUD.unsub) { try{ CLOUD.unsub(); }catch(_){} }
      CLOUD.unsub = onSnapshot(d, (snap)=>{
        if(!snap.exists()) return;
        const data = snap.data();
        const t = Number(data.updatedAt || 0);

        // ÿ•ÿ∞ÿß ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ ÿ´ÿßŸÜŸä (ÿ£ÿ≠ÿØÿ´ ŸÖŸÜ ÿ¢ÿÆÿ± ŸÉÿ™ÿßÿ®ÿ© ŸÖÿ≠ŸÑŸäÿ©) -> ŸÜÿ≤ŸëŸÑŸá
        if (t > (CLOUD.lastLocalWrite || 0)) {
          applyCloudPayload(data);
          showToast("üîÑ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ ÿ¢ÿÆÿ±", "info");
          setTimeout(()=> location.reload(), 600);
        }
      });
    }

    // =========================
    // ‚úÖ AUTH UI (ÿ¨ÿßŸáÿ≤ ÿ®ÿØŸàŸÜ ÿ™ÿπÿØŸäŸÑ HTML)
    // =========================
    function makeAuthBar(){
      const bar = document.createElement("div");
      bar.style.position = "fixed";
      bar.style.top = "12px";
      bar.style.left = "12px";
      bar.style.zIndex = "99999";
      bar.style.display = "flex";
      bar.style.gap = "8px";
      bar.style.alignItems = "center";
      bar.style.padding = "8px 10px";
      bar.style.borderRadius = "14px";
      bar.style.background = "rgba(15,23,42,.65)";
      bar.style.border = "1px solid rgba(148,163,184,.18)";
      bar.style.backdropFilter = "blur(10px)";

      const status = document.createElement("span");
      status.style.fontSize = "12px";
      status.style.color = "#e2e8f0";
      status.textContent = "‚òÅÔ∏è ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ";

      const btnLogin = document.createElement("button");
      btnLogin.textContent = "ÿØÿÆŸàŸÑ";
      btnLogin.style.cssText = "padding:6px 10px;border-radius:10px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.45);color:#fff;font-weight:700;cursor:pointer";

      const btnRegister = document.createElement("button");
      btnRegister.textContent = "ÿ™ÿ≥ÿ¨ŸäŸÑ";
      btnRegister.style.cssText = btnLogin.style.cssText;

      const btnLogout = document.createElement("button");
      btnLogout.textContent = "ÿÆÿ±Ÿàÿ¨";
      btnLogout.style.cssText = "padding:6px 10px;border-radius:10px;border:1px solid rgba(244,63,94,.25);background:rgba(244,63,94,.10);color:#fff;font-weight:800;cursor:pointer;display:none";

      btnLogin.onclick = async ()=>{
        const email = prompt("ÿßŸÉÿ™ÿ® ÿßŸÑÿßŸäŸÖŸäŸÑ:");
        if(!email) return;
        const pass = prompt("ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:");
        if(!pass) return;
        try{
          await signInWithEmailAndPassword(auth, email.trim(), pass);
          showToast("‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ", "success");
        }catch(e){
          console.error(e);
          showToast("‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿßŸäŸÖŸäŸÑ/ÿßŸÑÿ®ÿßÿ≥Ÿàÿ±ÿØ)", "error");
        }
      };

      btnRegister.onclick = async ()=>{
        const email = prompt("ÿßŸÉÿ™ÿ® ÿßŸÑÿßŸäŸÖŸäŸÑ ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:");
        if(!email) return;
        const pass = prompt("ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± (6 ÿ£ÿ≠ÿ±ŸÅ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±):");
        if(!pass) return;
        try{
          await createUserWithEmailAndPassword(auth, email.trim(), pass);
          showToast("‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ", "success");
        }catch(e){
          console.error(e);
          showToast("‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ (ŸäŸÖŸÉŸÜ ÿßŸÑÿßŸäŸÖŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÇÿµŸäÿ±ÿ©)", "error");
        }
      };

      btnLogout.onclick = async ()=>{
        try{
          await signOut(auth);
          showToast("‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨", "success");
        }catch(e){
          console.error(e);
          showToast("‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨", "error");
        }
      };

      bar.appendChild(status);
      bar.appendChild(btnLogin);
      bar.appendChild(btnRegister);
      bar.appendChild(btnLogout);
      document.body.appendChild(bar);

      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ©
      onAuthStateChanged(auth, async (user)=>{
        if(user){
          CLOUD.uid = user.uid;
          CLOUD.email = user.email || "";
          status.textContent = `‚òÅÔ∏è ŸÖÿ≥ÿ¨ŸÑ: ${CLOUD.email}`;
          btnLogout.style.display = "";
          btnLogin.style.display = "none";
          btnRegister.style.display = "none";

          await cloudLoadOnce();
          cloudListen();
        }else{
          CLOUD.uid = null;
          CLOUD.email = null;
          status.textContent = "‚òÅÔ∏è ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ (ŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑)";
          btnLogout.style.display = "none";
          btnLogin.style.display = "";
          btnRegister.style.display = "";

          if(CLOUD.unsub){ try{ CLOUD.unsub(); }catch(_){} CLOUD.unsub=null; }
        }
      });
    }

    // =========================
    // ‚úÖ Local Storage ÿßŸÑÿ£ÿµŸÑŸäÿ© (ŸÖÿπ ÿ±ŸÅÿπ ŸÑŸÑÿ≥ÿ≠ÿßÿ®ÿ©)
    // =========================
    function saveActive() {
      const keys = K();
      const s = S();
      localStorage.setItem(keys.data, JSON.stringify(s.inventory));
      localStorage.setItem(keys.pulled, String(s.pulledCounter));
      if (s.currentAccount) localStorage.setItem(keys.last, JSON.stringify(s.currentAccount));
      cloudSaveDebounced(); // ‚úÖ
    }

    function loadActive() {
      const keys = K();
      const data = localStorage.getItem(keys.data);
      const pulled = localStorage.getItem(keys.pulled);
      const s = S();
      s.inventory = data ? safeJsonParse(data, []) : [];
      s.pulledCounter = pulled ? Number(pulled) || 0 : 0;
      const last = localStorage.getItem(keys.last);
      s.currentAccount = last ? safeJsonParse(last, null) : null;
    }

    function getLastPulled(id) {
      const keys = keysFor(id);
      const last = localStorage.getItem(keys.last);
      return last ? safeJsonParse(last, null) : null;
    }
    function clearLastPulled(id) {
      const keys = keysFor(id);
      localStorage.removeItem(keys.last);
      cloudSaveDebounced(); // ‚úÖ
    }

    function ensureMeta(){
      const raw = localStorage.getItem(META_KEY);
      if (raw) inventoriesMeta = safeJsonParse(raw, []);

      if (!Array.isArray(inventoriesMeta) || inventoriesMeta.length === 0) {
        inventoriesMeta = [
          { id:'main', name:'ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä', type:'legacy-main' },
          { id:GO_ID, name:'Go', type:'legacy-gemini' },
          { id:NEW_GEMINI_ID, name:'Gemini', type:'custom' }
        ];
        localStorage.setItem(META_KEY, JSON.stringify(inventoriesMeta));
      } else {
        if (!inventoriesMeta.some(x => x.id === 'main')) {
          inventoriesMeta.unshift({ id:'main', name:'ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä', type:'legacy-main' });
        }
        const go = inventoriesMeta.find(x => x.id === GO_ID);
        if (!go) inventoriesMeta.push({ id:GO_ID, name:'Go', type:'legacy-gemini' });
        else { go.name = 'Go'; go.type = 'legacy-gemini'; }

        if (!inventoriesMeta.some(x => x.id === NEW_GEMINI_ID)) {
          inventoriesMeta.push({ id:NEW_GEMINI_ID, name:'Gemini', type:'custom' });
        }
        localStorage.setItem(META_KEY, JSON.stringify(inventoriesMeta));
      }

      const savedActive = localStorage.getItem(ACTIVE_KEY);
      if (savedActive && inventoriesMeta.some(x => x.id === savedActive)) {
        activeInvId = savedActive;
      } else {
        activeInvId = 'main';
        localStorage.setItem(ACTIVE_KEY, activeInvId);
      }

      inventoriesMeta.forEach(m => {
        if (!store[m.id]) store[m.id] = { inventory: [], pulledCounter: 0, currentAccount: null };
      });
    }

    function updateHeaderTitle(){
      titleNameEl.textContent = 'ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ';
    }

    function buildTabs(){
      tabsWrap.innerHTML = '';
      for (const inv of inventoriesMeta) {
        const btn = document.createElement('button');
        btn.className = "press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold text-slate-100";
        if (inv.id === activeInvId) btn.classList.add('tab-active');

        let icon = 'fa-layer-group';
        let iconColor = 'text-blue-300';
        if (inv.id === GO_ID) { icon = 'fa-bolt'; iconColor = 'text-emerald-300'; }
        if (inv.id === NEW_GEMINI_ID) { icon = 'fa-wand-magic-sparkles'; iconColor = 'text-sky-300'; }
        if (inv.id !== 'main' && inv.id !== GO_ID && inv.id !== NEW_GEMINI_ID) { icon = 'fa-box'; iconColor = 'text-amber-300'; }

        btn.innerHTML = `<i class="fa-solid ${icon} ml-2 ${iconColor}"></i>${inv.name}`;
        btn.addEventListener('click', () => setActiveInventory(inv.id));
        tabsWrap.appendChild(btn);
      }
    }

    function setStockCounterColor(stockLen) {
      if (stockLen === 0) stockCountEl.className = "text-2xl font-extrabold text-red-400";
      else if (stockLen < 5) stockCountEl.className = "text-2xl font-extrabold text-amber-300";
      else stockCountEl.className = "text-2xl font-extrabold text-emerald-300";
    }

    function displayResult(acc) {
      if (!acc) return;
      resultAreaEl.classList.remove('hidden');
      emailDisplayEl.textContent = acc.email || '---';
      passDisplayEl.textContent = acc.password || '---';
      recDisplayEl.textContent = acc.recovery || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
      urlBtnEl.href = acc.url && acc.url !== '' ? acc.url : '#';
      timestampEl.textContent = new Date().toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function updateUI() {
      const s = S();
      stockCountEl.textContent = s.inventory.length;
      pulledCountEl.textContent = s.pulledCounter;
      setStockCounterColor(s.inventory.length);

      const last = s.currentAccount || getLastPulled(activeInvId);
      if (last) {
        s.currentAccount = last;
        displayResult(last);
      } else {
        resultAreaEl.classList.add('hidden');
      }
    }

    function setActiveInventory(id){
      if (!inventoriesMeta.some(x => x.id === id)) return;
      activeInvId = id;
      localStorage.setItem(ACTIVE_KEY, id);

      loadActive();
      updateHeaderTitle();
      buildTabs();
      updateUI();
      renderMoveButtons();

      cloudSaveDebounced(); // ‚úÖ
    }

    function createNewInventory(){
      flash(addInvBtn);
      const name = prompt('ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑÿ¨ÿØŸäÿØ:');
      if (!name || !String(name).trim()) { showToast('ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° (ÿßÿ≥ŸÖ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÅÿßÿ±ÿ∫).', 'error'); return; }
      const n = String(name).trim();
      if (inventoriesMeta.some(x => x.name === n)) { showToast('Ÿáÿ∞ÿß ÿßŸÑÿßÿ≥ŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ. ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖ ŸÖÿÆÿ™ŸÑŸÅ.', 'error'); return; }

      const id = 'inv_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,7);
      inventoriesMeta.push({ id, name: n, type:'custom' });
      localStorage.setItem(META_KEY, JSON.stringify(inventoriesMeta));
      store[id] = { inventory: [], pulledCounter: 0, currentAccount: null };

      buildTabs();
      setActiveInventory(id);
      showToast('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿÆÿ≤ŸàŸÜ ÿ¨ÿØŸäÿØ ‚úÖ', 'success');

      cloudSaveDebounced(); // ‚úÖ
    }

    function parseStandardLine(line) {
      const parts = line.split(';').map(p => p.trim());
      if (parts.length < 2) return { ok: false };
      const email = parts[0];
      const password = parts[1];
      const recovery = parts[2] || "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±";
      const url = parts[3] || "#";
      if (!email || !password) return { ok: false };
      return { ok: true, acc: { email, password, recovery, url } };
    }

    function addToStockInternal(standardText) {
      const s = S();
      const stdLines = (standardText || '').replace(/\r/g, '').split('\n').map(l => l.trim()).filter(l => l.length >= 5);

      let addedCount = 0, duplicateCount = 0, invalidCount = 0;

      function existsEmail(email){ return s.inventory.some(a => a.email === email); }

      for (const line of stdLines) {
        const parsed = parseStandardLine(line);
        if (!parsed.ok) { invalidCount++; continue; }
        const acc = parsed.acc;
        if (existsEmail(acc.email)) { duplicateCount++; continue; }
        s.inventory.push(acc); addedCount++;
      }

      saveActive();
      updateUI();
      return { addedCount, duplicateCount, invalidCount };
    }

    function addToStock() {
      flash(addBtn);
      const standard = bulkInputEl.value;
      if (!standard.trim()) { showToast('ÿßŸÑÿ≠ŸÇŸÑ ŸÅÿßÿ±ÿ∫!', 'error'); return; }
      const { addedCount, duplicateCount, invalidCount } = addToStockInternal(standard);
      bulkInputEl.value = '';

      const tabName = getInvMetaById(activeInvId)?.name || 'ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ';
      let msg = `(${tabName}) ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${addedCount} ÿ≠ÿ≥ÿßÿ®.`;
      if (duplicateCount) msg += ` (ŸÖŸÉÿ±ÿ±: ${duplicateCount})`;
      if (invalidCount) msg += ` (ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠: ${invalidCount})`;
      showToast(msg, addedCount ? 'success' : 'error');
    }

    function pullAccount() {
      flash(pullBtn);
      const s = S();
      if (s.inventory.length === 0) { showToast('ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÅÿßÿ±ÿ∫.', 'error'); return; }
      const acc = s.inventory.splice(0, 1)[0];
      s.currentAccount = acc;
      s.pulledCounter++;
      saveActive();
      displayResult(acc);
      updateUI();
      showToast('ÿ™ŸÖ ÿ≥ÿ≠ÿ® ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    }

    function clearStorage() {
      flash(clearBtn);
      const tabName = getInvMetaById(activeInvId)?.name || 'ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ';
      if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ŸÖÿÆÿ≤ŸàŸÜ (${tabName}) ÿ®ÿßŸÑŸÉÿßŸÖŸÑÿü`)) return;

      const s = S();
      s.inventory = [];
      s.pulledCounter = 0;
      s.currentAccount = null;

      const keys = K();
      localStorage.removeItem(keys.data);
      localStorage.removeItem(keys.pulled);
      localStorage.removeItem(keys.last);
      localStorage.removeItem(keys.undo);

      updateUI();
      cloudSaveDebounced(); // ‚úÖ
      showToast('ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ', 'success');
    }

    async function copyField(type) {
      const s = S();
      const acc = s.currentAccount || getLastPulled(activeInvId);
      if (!acc) { showToast('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≥ÿ≠Ÿàÿ® ŸÑŸÑŸÜÿ≥ÿÆ.', 'error'); return; }
      let text = '', label = '';
      if (type === 'email') { text = acc.email; label = 'ÿßŸÑÿ•ŸäŸÖŸäŸÑ'; }
      else if (type === 'password') { text = acc.password; label = 'ÿßŸÑÿ®ÿßÿ≥Ÿàÿ±ÿØ'; }
      else { text = acc.recovery; label = 'ÿßŸÑÿ™ÿ≠ŸÇŸÇ'; }
      const ok = await copyText(String(text || ''));
      showToast(ok ? `ÿ™ŸÖ ŸÜÿ≥ÿÆ ${label}` : 'ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ (ÿ¨ÿ±Ÿëÿ® HTTPS ÿ£Ÿà localhost)', ok ? 'copy' : 'error');
    }

    async function copyFullCombo() {
      flash(copyFullBtn);
      const s = S();
      const acc = s.currentAccount || getLastPulled(activeInvId);
      if (!acc) { showToast('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≥ÿ≠Ÿàÿ® ŸÑŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™.', 'error'); return; }

      const textToCopy =
        `ÿßŸÑÿßŸäŸÖŸäŸÑ: ${acc.email}\n` +
        `ÿßŸÑÿ®ÿßÿ≥Ÿàÿ±ÿØ: ${acc.password}\n` +
        `ÿßŸÑÿ™ÿ≠ŸÇŸÇ: ${acc.recovery}\n` +
        `ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ: ${acc.url || "#"}`;

      const ok = await copyText(textToCopy);
      showToast(ok ? 'ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÉÿßŸÖŸÑÿ©' : 'ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ (ÿ¨ÿ±Ÿëÿ® HTTPS ÿ£Ÿà localhost)', ok ? 'success' : 'error');
    }

    function deleteLastPulled() {
      flash(deleteLastBtn);
      const s = S();
      const acc = s.currentAccount || getLastPulled(activeInvId);
      if (!acc) { showToast('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≥ÿ≠Ÿàÿ®.', 'error'); return; }
      s.currentAccount = null;
      clearLastPulled(activeInvId);
      saveActive();
      resultAreaEl.classList.add('hidden');
      showToast('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑÿ¥ÿßÿ¥ÿ©', 'success');
    }

    function restoreLastPulled() {
      flash(restoreBtn);
      const s = S();
      const acc = s.currentAccount || getLastPulled(activeInvId);
      if (!acc) { showToast('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≥ÿ≠Ÿàÿ® ŸÑŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ.', 'error'); return; }
      if (!s.inventory.some(a => a.email === acc.email)) s.inventory.unshift(acc);
      if (s.pulledCounter > 0) s.pulledCounter--;
      s.currentAccount = null;
      clearLastPulled(activeInvId);
      saveActive();
      updateUI();
      showToast('ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ•ŸÑŸâ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ', 'success');
    }

    function moveAccountTo(targetInvId, targetLabel){
      if (activeInvId !== 'main') { showToast('ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÜŸÇŸÑ ÿ™ÿπŸÖŸÑ ŸÖŸÜ (ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä) ŸÅŸÇÿ∑.', 'error'); return; }

      const sMain = store['main'] || S();
      const acc = sMain.currentAccount || getLastPulled('main');
      if (!acc) { showToast('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≥ÿ≠Ÿàÿ® ŸÑŸÑŸÜŸÇŸÑ.', 'error'); return; }

      if (!store[targetInvId]) store[targetInvId] = { inventory: [], pulledCounter: 0, currentAccount: null };

      const prevActive = activeInvId;

      activeInvId = targetInvId;
      loadActive();
      const sTarget = store[targetInvId];

      if (sTarget.inventory.some(a => a.email === acc.email)) {
        activeInvId = prevActive;
        showToast(`Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä ŸÖÿÆÿ≤ŸàŸÜ ${targetLabel} (ÿ™ŸÖ ŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±).`, 'error');
        return;
      }

      sTarget.inventory.unshift(acc);
      activeInvId = targetInvId;
      saveActive();

      sMain.currentAccount = null;
      clearLastPulled('main');

      activeInvId = 'main';
      saveActive();

      activeInvId = prevActive;
      updateUI();

      showToast(`ÿ™ŸÖ ŸÜŸÇŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ•ŸÑŸâ ŸÖÿÆÿ≤ŸàŸÜ ${targetLabel}`, 'success');
    }

    function renderMoveButtons(){
      moveButtonsWrap.innerHTML = '';
      if (activeInvId !== 'main') return;

      const targets = inventoriesMeta.filter(x => x.id !== 'main');
      if (!targets.length) return;

      for (const t of targets) {
        const btn = document.createElement('button');
        btn.className = "press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2";
        btn.innerHTML = `<i class="fa-solid fa-right-left text-slate-200"></i><span>ÿßŸÑŸÜŸÇŸÑ ÿ•ŸÑŸâ ${t.name}</span>`;
        btn.addEventListener('click', () => moveAccountTo(t.id, t.name));
        moveButtonsWrap.appendChild(btn);
      }
    }

    async function importTxtFile(file) {
      if (!file) return;
      flash(importBtn);
      if (!file.name.toLowerCase().endsWith('.txt')) { showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ TXT ŸÅŸÇÿ∑', 'error'); return; }
      try {
        const content = await file.text();
        const { addedCount, duplicateCount, invalidCount } = addToStockInternal(content);
        let msg = `ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑŸÖŸÑŸÅ: +${addedCount}`;
        if (duplicateCount) msg += ` (ŸÖŸÉÿ±ÿ±: ${duplicateCount})`;
        if (invalidCount) msg += ` (ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠: ${invalidCount})`;
        showToast(msg, addedCount ? 'success' : 'error');
      } catch (e) { showToast('ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ', 'error'); }
    }

    function exportStockToTxt() {
      flash(exportBtn);
      const s = S();
      if (!s.inventory.length) { showToast('ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÅÿßÿ±ÿ∫.', 'error'); return; }
      const content = s.inventory.map(acc => `${acc.email};${acc.password};${acc.recovery};${acc.url}`).join('\n');
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const meta = getInvMetaById(activeInvId);
      const safeName = (meta?.name || 'inventory').replace(/[^\w\u0600-\u06FF]+/g,'_');

      const a = document.createElement('a');
      a.href = url;
      a.download = `${safeName}_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${s.inventory.length} ÿ≠ÿ≥ÿßÿ®`, 'success');
    }

    // ===== Settings modal =====
    function openSettings(){
      flash(settingsBtn);
      renderSettingsInventories();
      settingsModal.classList.add('show');
      document.body.classList.add('modal-open');
    }
    function closeSettings(){
      settingsModal.classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    function deleteInventory(invId){
      const meta = getInvMetaById(invId);
      if (!meta) return;
      if (!confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ŸÖÿÆÿ≤ŸàŸÜ: (${meta.name}) ŸÖŸÜ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜÿü\nŸáÿ∞ÿß ÿ≥Ÿäÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ŸäŸÖŸäŸÑÿßÿ™ ŸàÿßŸÑÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿÆÿßÿµÿ© ÿ®Ÿá ŸÅŸÇÿ∑.`)) return;

      const keys = keysFor(invId);
      localStorage.removeItem(keys.data);
      localStorage.removeItem(keys.pulled);
      localStorage.removeItem(keys.last);
      localStorage.removeItem(keys.undo);

      inventoriesMeta = inventoriesMeta.filter(x => x.id !== invId);

      if (!inventoriesMeta.some(x => x.id === 'main')) inventoriesMeta.unshift({ id:'main', name:'ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä', type:'legacy-main' });

      const go = inventoriesMeta.find(x => x.id === GO_ID);
      if (!go) inventoriesMeta.push({ id:GO_ID, name:'Go', type:'legacy-gemini' });
      else { go.name='Go'; go.type='legacy-gemini'; }

      if (!inventoriesMeta.some(x => x.id === NEW_GEMINI_ID)) inventoriesMeta.push({ id:NEW_GEMINI_ID, name:'Gemini', type:'custom' });

      localStorage.setItem(META_KEY, JSON.stringify(inventoriesMeta));

      if (activeInvId === invId) {
        activeInvId = inventoriesMeta[0].id;
        localStorage.setItem(ACTIVE_KEY, activeInvId);
      }

      delete store[invId];
      buildTabs();
      setActiveInventory(activeInvId);
      renderSettingsInventories();
      cloudSaveDebounced(); // ‚úÖ
      showToast('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ‚úÖ', 'success');
    }

    function renderSettingsInventories(){
      invListWrap.innerHTML = '';
      for (const inv of inventoriesMeta) {
        const row = document.createElement('div');
        row.className = "flex flex-col md:flex-row gap-2 md:items-center md:justify-between bg-slate-950/25 border border-slate-700/40 rounded-2xl p-3";

        const left = document.createElement('div');
        left.className = "text-sm text-slate-100";
        left.innerHTML = `<div class="font-extrabold">${inv.name}</div><div class="text-xs text-slate-300">ID: ${inv.id}</div>`;

        const right = document.createElement('div');
        right.className = "flex gap-2";

        const switchBtn = document.createElement('button');
        switchBtn.className = "press-glow soft bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-4 py-2 rounded-2xl text-sm";
        switchBtn.innerHTML = `<i class="fa-solid fa-arrow-right-arrow-left ml-2 text-slate-200"></i>ŸÅÿ™ÿ≠`;
        switchBtn.addEventListener('click', () => { setActiveInventory(inv.id); closeSettings(); });

        const delBtn = document.createElement('button');
        delBtn.className = "press-glow soft bg-red-700/20 hover:bg-red-700/28 border border-red-700/30 text-red-100 font-bold px-4 py-2 rounded-2xl text-sm";
        delBtn.innerHTML = `<i class="fa-solid fa-trash ml-2 text-red-300"></i>ÿ≠ÿ∞ŸÅ`;
        delBtn.addEventListener('click', () => deleteInventory(inv.id));

        right.appendChild(switchBtn);
        right.appendChild(delBtn);

        row.appendChild(left);
        row.appendChild(right);
        invListWrap.appendChild(row);
      }
    }

    // ===== Links =====
    function loadLinks(){
      const raw = localStorage.getItem(LINKS_KEY);
      quickLinks = raw ? safeJsonParse(raw, []) : [];
      if (!Array.isArray(quickLinks)) quickLinks = [];

      if (!quickLinks.length) {
        quickLinks = [
          { id:'l1', name:'ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ChatGPT', url:'https://batch.1key.me/' },
          { id:'l2', name:'ÿ®Ÿàÿ™ ÿßŸÑÿ™ÿ≠ŸÇŸÇ', url:'https://t.me/Veriyferbot' }
        ];
        saveLinks();
      }
    }
    function saveLinks(){ localStorage.setItem(LINKS_KEY, JSON.stringify(quickLinks)); cloudSaveDebounced(); }

    function openLinks(){
      flash(linksBtn);
      renderLinks();
      linksModal.classList.add('show');
      document.body.classList.add('modal-open');
    }
    function closeLinks(){
      linksModal.classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    function swapLinks(i, j){
      if (i < 0 || j < 0) return;
      if (i >= quickLinks.length || j >= quickLinks.length) return;
      const tmp = quickLinks[i];
      quickLinks[i] = quickLinks[j];
      quickLinks[j] = tmp;
      saveLinks();
      renderLinks();
    }

    function removeLinkById(id){
      const item = quickLinks.find(x => x.id === id);
      if (!item) return;
      if (!confirm(`ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ±ÿßÿ®ÿ∑: ${item.name} ÿü`)) return;
      quickLinks = quickLinks.filter(x => x.id !== id);
      saveLinks();
      renderLinks();
      showToast('ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ±ÿßÿ®ÿ∑', 'success');
    }

    function renderLinks(){
      linksWrap.innerHTML = '';

      for (let idx = 0; idx < quickLinks.length; idx++) {
        const item = quickLinks[idx];

        const row = document.createElement('div');
        row.className = "bg-slate-950/20 border border-slate-700/40 rounded-2xl p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3";

        const left = document.createElement('button');
        left.className = "min-w-0 text-right flex-1";
        left.innerHTML = `
          <div class="font-extrabold text-white truncate hover:underline" title="ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÜÿ≥ÿÆ">${item.name || 'ÿ±ÿßÿ®ÿ∑'}</div>
          <div class="text-xs text-slate-300 mt-1 break-words">${item.url || ''}</div>
        `;
        left.addEventListener('click', async () => {
          const ok = await copyText(String(item.url || ''));
          showToast(ok ? 'ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑' : 'ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ', ok ? 'copy' : 'error');
        });

        const right = document.createElement('div');
        right.className = "flex gap-2 flex-shrink-0 flex-wrap justify-start sm:justify-end";

        const upBtn = document.createElement('button');
        upBtn.className = "press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-3 py-2 rounded-2xl text-sm";
        upBtn.textContent = '‚Üë';
        upBtn.disabled = idx === 0;
        upBtn.style.opacity = idx === 0 ? '.45' : '1';
        upBtn.addEventListener('click', () => swapLinks(idx, idx - 1));

        const downBtn = document.createElement('button');
        downBtn.className = "press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-3 py-2 rounded-2xl text-sm";
        downBtn.textContent = '‚Üì';
        downBtn.disabled = idx === quickLinks.length - 1;
        downBtn.style.opacity = idx === quickLinks.length - 1 ? '.45' : '1';
        downBtn.addEventListener('click', () => swapLinks(idx, idx + 1));

        const copyBtn = document.createElement('button');
        copyBtn.className = "press-glow soft bg-blue-700/20 hover:bg-blue-700/28 border border-blue-700/30 text-blue-100 font-bold px-4 py-2 rounded-2xl text-sm";
        copyBtn.textContent = 'ŸÜÿ≥ÿÆ';
        copyBtn.addEventListener('click', async () => {
          const ok = await copyText(String(item.url || ''));
          showToast(ok ? 'ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑' : 'ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ', ok ? 'copy' : 'error');
        });

        const openBtn = document.createElement('button');
        openBtn.className = "press-glow soft bg-emerald-700/20 hover:bg-emerald-700/28 border border-emerald-700/30 text-emerald-100 font-bold px-4 py-2 rounded-2xl text-sm";
        openBtn.textContent = 'ŸÅÿ™ÿ≠';
        openBtn.addEventListener('click', () => {
          const u = item.url || '';
          if(!u) return;
          window.open(u, '_blank', 'noopener');
        });

        const removeBtn = document.createElement('button');
        removeBtn.className = "press-glow soft bg-red-700/20 hover:bg-red-700/28 border border-red-700/30 text-red-100 font-bold px-4 py-2 rounded-2xl text-sm";
        removeBtn.textContent = 'ÿ•ÿ≤ÿßŸÑÿ©';
        removeBtn.addEventListener('click', () => removeLinkById(item.id));

        right.appendChild(upBtn);
        right.appendChild(downBtn);
        right.appendChild(copyBtn);
        right.appendChild(openBtn);
        right.appendChild(removeBtn);

        row.appendChild(left);
        row.appendChild(right);
        linksWrap.appendChild(row);
      }
    }

    function addLink(){
      flash(addLinkBtn);
      const name = prompt('ÿßÿ≥ŸÖ ÿßŸÑÿ±ÿßÿ®ÿ∑:');
      if (!name || !String(name).trim()) { showToast('ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° (ÿßŸÑÿßÿ≥ŸÖ ŸÅÿßÿ±ÿ∫).', 'error'); return; }
      const urlIn = prompt('ÿßŸÑÿ±ÿßÿ®ÿ∑:');
      if (!urlIn || !String(urlIn).trim()) { showToast('ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° (ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÅÿßÿ±ÿ∫).', 'error'); return; }
      const url = normalizeUrl(urlIn);
      if (!url) { showToast('ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠.', 'error'); return; }

      const id = 'l_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6);
      quickLinks.push({ id, name: String(name).trim(), url });
      saveLinks();
      renderLinks();
      showToast('ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚úÖ', 'success');
    }

    // ===== Events =====
    toggleBtn.addEventListener('click', () => { flash(toggleBtn); inputSectionEl.classList.toggle('hidden'); });
    clearBtn.addEventListener('click', clearStorage);
    addBtn.addEventListener('click', addToStock);
    pullBtn.addEventListener('click', pullAccount);
    copyFullBtn.addEventListener('click', copyFullCombo);

    restoreBtn.addEventListener('click', restoreLastPulled);
    deleteLastBtn.addEventListener('click', deleteLastPulled);

    importBtn.addEventListener('click', () => { flash(importBtn); importFile.click(); });
    importFile.addEventListener('change', async () => {
      const file = importFile.files && importFile.files[0] ? importFile.files[0] : null;
      await importTxtFile(file);
      importFile.value = '';
    });

    exportBtn.addEventListener('click', exportStockToTxt);

    document.querySelectorAll('[data-copy]').forEach(card => {
      card.addEventListener('click', () => { flash(card); copyField(card.getAttribute('data-copy')); });
    });

    addInvBtn.addEventListener('click', createNewInventory);

    settingsBtn.addEventListener('click', openSettings);
    closeSettingsBtn.addEventListener('click', closeSettings);
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });

    linksBtn.addEventListener('click', openLinks);
    closeLinksBtn.addEventListener('click', closeLinks);
    addLinkBtn.addEventListener('click', addLink);
    linksModal.addEventListener('click', (e) => { if (e.target === linksModal) closeLinks(); });

    // ===== Init =====
    window.addEventListener('load', () => {
      ensureMeta();
      loadLinks();

      // ÿ≠ŸÖŸëŸÑ ŸÉŸÑ ÿßŸÑŸÖÿÆÿßÿ≤ŸÜ ŸÖÿ±ÿ©
      for (const inv of inventoriesMeta) {
        const prev = activeInvId;
        activeInvId = inv.id;
        loadActive();
        activeInvId = prev;
      }

      buildTabs();
      setActiveInventory(activeInvId);

      // ‚úÖ Auth bar + Cloud
      makeAuthBar();
    });

    // ===== Snow =====
    const canvas = document.getElementById('snowCanvas');
    const ctx = canvas.getContext('2d', { alpha: true });
    let W = 0, H = 0;

    function resize(){
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize, { passive:true });
    resize();

    const flakes = Array.from({ length: 55 }, () => ({
      x: Math.random()*W,
      y: Math.random()*H,
      r: 0.6 + Math.random()*1.6,
      v: 0.25 + Math.random()*0.9,
      drift: (Math.random()*0.6) - 0.3,
      a: 0.12 + Math.random()*0.20
    }));

    function snowTick(){
      ctx.clearRect(0,0,W,H);
      for(const f of flakes){
        f.y += f.v;
        f.x += f.drift;

        if (f.y > H + 5) { f.y = -5; f.x = Math.random()*W; }
        if (f.x > W + 5) f.x = -5;
        if (f.x < -5) f.x = W + 5;

        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.closePath();
        ctx.fillStyle = `rgba(255,255,255,${f.a})`;
        ctx.fill();
      }
      requestAnimationFrame(snowTick);
    }
    snowTick();

  })();
</script>
