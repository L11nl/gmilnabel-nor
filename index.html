<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø°ÙƒÙŠ | Smart Inventory (Cloud + Local Per User)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- âœ… Firebase (CDN - compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <style>
    body{
      font-family:'Tajawal', sans-serif;
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(16,185,129,.12), transparent 55%),
        #0b1224;
      color:#e2e8f0;
      overflow-x:hidden;
    }

    ::-webkit-scrollbar{ width:8px; }
    ::-webkit-scrollbar-track{ background:#070c18; }
    ::-webkit-scrollbar-thumb{ background:#3b82f6; border-radius:6px; }
    ::-webkit-scrollbar-thumb:hover{ background:#2563eb; }

    .glass-panel{
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .soft{
      transition: background .16s ease, border-color .16s ease, box-shadow .16s ease, transform .06s ease;
      will-change: auto;
    }

    .press-glow:active{
      box-shadow: 0 0 0 3px rgba(255,255,255,.08), 0 0 18px rgba(59,130,246,.20);
      transform: translateY(1px);
    }

    .flash{ animation: flash .22s ease-out; }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 rgba(255,255,255,0); }
      100%{ box-shadow: 0 0 0 3px rgba(255,255,255,.08), 0 0 22px rgba(56,189,248,.20); }
    }

    .field-copy{
      cursor:pointer;
      transition: background .16s ease, border-color .16s ease, box-shadow .16s ease;
    }
    .field-copy:hover{
      background-color: rgba(51,65,85,.25);
      border-color: rgba(59,130,246,.35);
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }

    .tab-pill{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.45);
      white-space: nowrap;
    }
    .tab-active{
      border-color: rgba(59,130,246,.45);
      background: rgba(59,130,246,.10);
      box-shadow: 0 0 0 3px rgba(59,130,246,.12);
    }

    #snowCanvas{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      opacity: .55;
    }

    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-backdrop.show{ display:flex; }

    body.modal-open{
      overflow: hidden;
      touch-action: none;
    }

    .modal-panel{
      max-height: 82vh;
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .nbb-verified{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
    }
    .nbb-badge{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(148,163,184,.22);
      animation: badgeShift 1.8s ease-in-out infinite;
      box-shadow: 0 0 18px rgba(59,130,246,.10);
    }
    @keyframes badgeShift{
      0%   { background: rgba(59,130,246,.30); box-shadow: 0 0 18px rgba(59,130,246,.18); }
      50%  { background: rgba(16,185,129,.28); box-shadow: 0 0 18px rgba(16,185,129,.18); }
      100% { background: rgba(168,85,247,.28); box-shadow: 0 0 18px rgba(168,85,247,.18); }
    }
    .nbb-fire i{
      filter: drop-shadow(0 0 10px rgba(251,146,60,.22));
      animation: flame 1.1s ease-in-out infinite;
      transform-origin: 50% 60%;
    }
    @keyframes flame{
      0%{ transform: translateY(0) scale(1); opacity: .9; }
      50%{ transform: translateY(-2px) scale(1.05); opacity: 1; }
      100%{ transform: translateY(0) scale(1); opacity: .9; }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center py-10 px-4">

  <canvas id="snowCanvas"></canvas>

  <header class="w-full max-w-5xl mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-5 relative z-10">
    <div class="space-y-2">
      <h1 class="text-3xl font-extrabold text-blue-400 flex items-center gap-3">
        <i class="fa-solid fa-boxes-stacked"></i>
        <span id="titleName">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
      </h1>

      <div class="nbb-verified w-fit">
        <span class="text-slate-200 font-bold text-sm">Ù…ØµÙ…Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù†Ø¨ÙŠÙ„</span>
        <span class="nbb-badge" title="Ù…ÙˆØ«Ù‚">
          <i class="fa-solid fa-check text-[10px] text-white"></i>
        </span>
        <span class="nbb-fire" title="ğŸ”¥">
          <i class="fa-solid fa-fire text-amber-300"></i>
        </span>
      </div>

      <div class="text-xs text-slate-300 mt-2">
        Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: <span id="cloudStatus" class="font-bold text-amber-300">ØºÙŠØ± Ù…ØªØµÙ„</span>
        â€¢ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="userLabel" class="font-mono text-slate-200">---</span>
      </div>
    </div>

    <div class="flex gap-3 w-full md:w-auto items-center">
      <div class="flex gap-2 items-center flex-wrap">
        <div id="tabsWrap" class="flex gap-2 flex-wrap"></div>

        <button id="addInvBtn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø²ÙˆÙ† Ø¬Ø¯ÙŠØ¯"
          class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-black text-slate-100">
          <i class="fa-solid fa-plus ml-2 text-emerald-300"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø²ÙˆÙ†
        </button>

        <button id="linksBtn" title="Ø±ÙˆØ§Ø¨Ø·"
          class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold text-slate-100">
          <i class="fa-solid fa-link ml-2 text-sky-300"></i> Ø±ÙˆØ§Ø¨Ø·
        </button>

        <button id="settingsBtn" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"
          class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold text-slate-100">
          <i class="fa-solid fa-gear ml-2 text-slate-300"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>

        <button id="logoutBtn" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬"
          class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold text-slate-100">
          <i class="fa-solid fa-right-from-bracket ml-2 text-rose-300"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>

      <div class="glass-panel soft px-5 py-3 rounded-2xl text-center shadow-lg shadow-blue-500/10">
        <span class="block text-xs text-slate-400">Ø§Ù„Ù…ØªÙˆÙØ± Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        <span id="stockCount" class="text-2xl font-extrabold text-emerald-300">0</span>
      </div>
      <div class="glass-panel soft px-5 py-3 rounded-2xl text-center shadow-lg shadow-purple-500/10">
        <span class="block text-xs text-slate-400">ØªÙ… Ø³Ø­Ø¨Ù‡Ø§</span>
        <span id="pulledCount" class="text-2xl font-extrabold text-purple-300">0</span>
      </div>
    </div>
  </header>

  <main class="w-full max-w-5xl space-y-6 relative z-10">

    <section class="glass-panel soft p-6 rounded-3xl shadow-xl">
      <div class="flex justify-between items-center mb-4 gap-3">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <i class="fa-solid fa-cloud-arrow-up text-blue-400"></i>
          <span>ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        </h2>

        <button id="toggleBtn" class="press-glow soft text-slate-300 hover:text-white text-sm underline">
          Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±
        </button>
      </div>

      <div id="inputSection" class="space-y-4">
        <textarea id="bulkInput" rows="5"
          class="w-full bg-slate-950/30 text-sm text-white p-4 rounded-2xl border border-slate-700/60 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition placeholder-slate-500"
          placeholder="Ø¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡Ù†Ø§ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:
email;pass;recovery;url
email;pass;recovery;url"></textarea>

        <div class="flex flex-col md:flex-row justify-between gap-3">
          <button id="clearBtn"
            class="press-glow soft text-red-200 hover:text-red-100 transition px-4 py-2 rounded-xl border border-red-900/40 bg-red-950/20 hover:bg-red-950/30">
            <i class="fa-solid fa-trash ml-1"></i> ØªØµÙÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
          </button>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="importBtn"
              class="press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-3 px-6 rounded-2xl flex items-center justify-center gap-2">
              <i class="fa-solid fa-file-arrow-up text-blue-300"></i>
              <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù</span>
            </button>
            <input id="importFile" type="file" accept=".txt" class="hidden" />

            <button id="exportBtn"
              class="press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-3 px-6 rounded-2xl flex items-center justify-center gap-2">
              <i class="fa-solid fa-file-arrow-down text-emerald-300"></i>
              <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
            </button>

            <button id="addBtn"
              class="press-glow soft bg-blue-600 hover:bg-blue-500 text-white font-extrabold py-3 px-7 rounded-2xl shadow-lg shadow-blue-600/15 flex items-center justify-center gap-2">
              <i class="fa-solid fa-plus"></i>
              <span>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <div class="flex justify-center py-2">
      <button id="pullBtn"
        class="press-glow soft relative group bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 text-white text-2xl font-black py-5 px-8 md:px-12 rounded-3xl shadow-2xl shadow-emerald-500/20 w-full md:w-auto">
        <div class="flex items-center justify-center gap-3">
          <i class="fa-solid fa-hand-holding-hand"></i>
          <span>Ø³Ø­Ø¨ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span>
        </div>
      </button>
    </div>

    <section id="resultArea" class="hidden">
      <div class="glass-panel soft p-1 rounded-[26px] border border-slate-600/50 shadow-2xl">
        <div class="bg-slate-950/25 rounded-[22px] p-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-4 border-b border-slate-700/60 gap-2">
            <span class="text-emerald-300 font-extrabold text-lg flex items-center gap-2">
              <i class="fa-solid fa-check-circle"></i>
              ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­
            </span>
            <span class="text-xs text-slate-400 font-mono" id="timestamp"></span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="press-glow field-copy soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 group" data-copy="email">
              <label class="text-xs text-slate-400 block mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Email)</label>
              <div class="flex justify-between items-center gap-3">
                <span id="emailDisplay" class="font-mono text-blue-300 truncate">---</span>
                <i class="fa-regular fa-copy text-slate-500 group-hover:text-white"></i>
              </div>
            </div>

            <div class="press-glow field-copy soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 group" data-copy="password">
              <label class="text-xs text-slate-400 block mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Password)</label>
              <div class="flex justify-between items-center gap-3">
                <span id="passDisplay" class="font-mono text-rose-300 truncate">---</span>
                <i class="fa-regular fa-copy text-slate-500 group-hover:text-white"></i>
              </div>
            </div>

            <div class="press-glow field-copy soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 group" data-copy="recovery">
              <label class="text-xs text-slate-400 block mb-1">Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ (Recovery Email)</label>
              <div class="flex justify-between items-center gap-3">
                <span id="recDisplay" class="font-mono text-amber-300 truncate">---</span>
                <i class="fa-regular fa-copy text-slate-500 group-hover:text-white"></i>
              </div>
            </div>

            <div class="soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 flex justify-between items-center gap-3">
              <div>
                <label class="text-xs text-slate-400 block mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Webhook)</label>
              </div>
              <a id="urlBtn" href="#" target="_blank" rel="noopener"
                 class="press-glow soft bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-4 py-2 rounded-xl transition shadow-lg shadow-indigo-600/15">
                <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i> ÙØªØ­
              </a>
            </div>
          </div>

          <div class="mt-2 space-y-2">
            <button id="copyFullBtn"
              class="press-glow soft w-full bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 group">
              <i class="fa-solid fa-clipboard-list text-blue-300"></i>
              <span>Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§Ù…Ù„Ø© (Ø´Ø§Ù…Ù„)</span>
            </button>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
              <button id="restoreBtn"
                class="press-glow soft bg-emerald-700/30 hover:bg-emerald-700/40 border border-emerald-700/35 text-emerald-100 font-bold py-3 rounded-2xl flex items-center justify-center gap-2">
                <i class="fa-solid fa-rotate-left text-emerald-300"></i>
                <span>Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</span>
              </button>

              <button id="deleteLastBtn"
                class="press-glow soft bg-red-700/20 hover:bg-red-700/28 border border-red-700/30 text-red-100 font-bold py-3 rounded-2xl flex items-center justify-center gap-2">
                <i class="fa-solid fa-xmark text-red-300"></i>
                <span>Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©</span>
              </button>
            </div>

            <div id="moveButtonsWrap" class="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-2"></div>

            <p class="text-center text-[11px] text-slate-300">
              âœ… Ø§Ù„Ø¢Ù† ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ù…Ø®Ø²ÙˆÙ† Ø®Ø§Øµ (Ù…Ø­Ù„ÙŠ + Ø³Ø­Ø§Ø¨ÙŠ) ÙˆÙ„ÙŠØ³ Ù…Ø´ØªØ±Ùƒ.
            </p>
          </div>

        </div>
      </div>
    </section>

  </main>

  <!-- Toast -->
  <div id="toast"
    class="fixed bottom-5 left-5 bg-slate-900/90 border border-slate-700/70 text-white px-5 py-3 rounded-2xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
    <i id="toastIcon" class="fa-solid fa-info-circle"></i>
    <span id="toastMsg">ØªÙ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</span>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-backdrop">
    <div class="glass-panel soft modal-panel w-full max-w-2xl rounded-3xl p-5 border border-slate-700/50 shadow-2xl">
      <div class="flex justify-between items-center mb-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-gear text-slate-300"></i>
          <span class="font-extrabold text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
          <span class="text-xs text-slate-300">Ø­Ø°Ù Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†</span>
        </div>
        <button id="closeSettingsBtn" class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold">
          Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>

      <div class="bg-slate-950/20 border border-slate-700/40 rounded-2xl p-4">
        <div class="text-sm text-slate-200 font-bold mb-2">ğŸ“¦ Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        <div id="invListWrap" class="space-y-2"></div>

        <p class="text-[11px] text-slate-300 mt-3">
          âš ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙŠØ¹Ù†ÙŠ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŒ ÙˆÙ„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø£Ø®Ø±Ù‰.
        </p>
      </div>
    </div>
  </div>

  <!-- Links Modal -->
  <div id="linksModal" class="modal-backdrop">
    <div class="glass-panel soft modal-panel w-full max-w-2xl rounded-3xl p-5 border border-slate-700/50 shadow-2xl">
      <div class="flex justify-between items-center mb-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-link text-sky-300"></i>
          <span class="font-extrabold text-white">Ø±ÙˆØ§Ø¨Ø·</span>
          <span class="text-xs text-slate-300">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù†Ø³Ø® â€” Ø²Ø± ÙØªØ­ Ù„Ù„ÙØªØ­</span>
        </div>
        <div class="flex gap-2">
          <button id="addLinkBtn"
            class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold text-slate-100"
            title="Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·">
            <i class="fa-solid fa-plus ml-2 text-sky-200"></i> +
          </button>
          <button id="closeLinksBtn" class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold">
            Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>
      </div>

      <div id="linksWrap" class="space-y-2"></div>

      <p class="text-[11px] text-slate-300 mt-3">
        âœ³ï¸ (Ø¥Ø²Ø§Ù„Ø©) Ù„Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· â€” (â†‘ â†“) Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø£Ùˆ Ù„Ù„Ø£Ø³ÙÙ„.
      </p>
    </div>
  </div>

  <!-- âœ… Auth Modal (Register/Login) -->
  <div id="authModal" class="modal-backdrop show">
    <div class="glass-panel soft modal-panel w-full max-w-xl rounded-3xl p-5 border border-slate-700/50 shadow-2xl">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-user-lock text-emerald-300"></i>
          <span class="font-extrabold text-white">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</span>
        </div>
      </div>

      <div class="bg-slate-950/20 border border-slate-700/40 rounded-2xl p-4 space-y-3">
        <input id="authEmail" type="email" placeholder="Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„"
          class="w-full bg-slate-950/30 text-white p-3 rounded-2xl border border-slate-700/60 outline-none" />
        <input id="authPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
          class="w-full bg-slate-950/30 text-white p-3 rounded-2xl border border-slate-700/60 outline-none" />

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="registerBtn" class="press-glow soft bg-blue-600 hover:bg-blue-500 text-white font-extrabold py-3 rounded-2xl">
            <i class="fa-solid fa-user-plus ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
          </button>
          <button id="loginBtn" class="press-glow soft bg-emerald-600 hover:bg-emerald-500 text-white font-extrabold py-3 rounded-2xl">
            <i class="fa-solid fa-right-to-bracket ml-2"></i> Ø¯Ø®ÙˆÙ„
          </button>
        </div>

        <p class="text-[12px] text-slate-300">
          âœ… ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ù…Ø®Ø²ÙˆÙ† Ø®Ø§Øµ Ø¨Ù‡ (Ù„ÙŠØ³ Ù…Ø´ØªØ±Ùƒ).
        </p>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // =========================
      // âœ… Firebase Config (Ù…Ø§Ù„ØªÙƒ)
      // =========================
      const firebaseConfig = {
        apiKey: "AIzaSyC4Q4qTILDP4eYuo8OpER_NQ4udj5lXSwM",
        authDomain: "nabeel-abd.firebaseapp.com",
        projectId: "nabeel-abd",
        storageBucket: "nabeel-abd.firebasestorage.app",
        messagingSenderId: "397355019788",
        appId: "1:397355019788:web:9d1961a81f62d06f44c829",
        measurementId: "G-9ES5BKWRVH"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // =========================
      // Ø¹Ù†Ø§ØµØ±
      // =========================
      const stockCountEl = document.getElementById('stockCount');
      const pulledCountEl = document.getElementById('pulledCount');
      const titleNameEl = document.getElementById('titleName');

      const tabsWrap = document.getElementById('tabsWrap');
      const addInvBtn = document.getElementById('addInvBtn');
      const settingsBtn = document.getElementById('settingsBtn');

      const linksBtn = document.getElementById('linksBtn');
      const linksModal = document.getElementById('linksModal');
      const closeLinksBtn = document.getElementById('closeLinksBtn');
      const addLinkBtn = document.getElementById('addLinkBtn');
      const linksWrap = document.getElementById('linksWrap');

      const settingsModal = document.getElementById('settingsModal');
      const closeSettingsBtn = document.getElementById('closeSettingsBtn');
      const invListWrap = document.getElementById('invListWrap');

      const inputSectionEl = document.getElementById('inputSection');
      const bulkInputEl = document.getElementById('bulkInput');

      const resultAreaEl = document.getElementById('resultArea');
      const timestampEl = document.getElementById('timestamp');

      const emailDisplayEl = document.getElementById('emailDisplay');
      const passDisplayEl = document.getElementById('passDisplay');
      const recDisplayEl = document.getElementById('recDisplay');
      const urlBtnEl = document.getElementById('urlBtn');

      const toggleBtn = document.getElementById('toggleBtn');
      const clearBtn = document.getElementById('clearBtn');
      const addBtn = document.getElementById('addBtn');
      const pullBtn = document.getElementById('pullBtn');
      const copyFullBtn = document.getElementById('copyFullBtn');

      const restoreBtn = document.getElementById('restoreBtn');
      const deleteLastBtn = document.getElementById('deleteLastBtn');

      const moveButtonsWrap = document.getElementById('moveButtonsWrap');

      const importBtn = document.getElementById('importBtn');
      const importFile = document.getElementById('importFile');
      const exportBtn = document.getElementById('exportBtn');

      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      const toastIcon = document.getElementById('toastIcon');
      let toastTimeout;

      // Auth UI
      const authModal = document.getElementById('authModal');
      const authEmail = document.getElementById('authEmail');
      const authPass  = document.getElementById('authPass');
      const registerBtn = document.getElementById('registerBtn');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      const cloudStatus = document.getElementById('cloudStatus');
      const userLabel = document.getElementById('userLabel');

      // =========================
      // Toast
      // =========================
      function flash(el){
        if(!el) return;
        el.classList.remove('flash');
        void el.offsetWidth;
        el.classList.add('flash');
        setTimeout(()=> el.classList.remove('flash'), 260);
      }

      function showToast(message, type = 'info') {
        toastMsg.textContent = message;
        toast.className =
          "fixed bottom-5 left-5 px-5 py-3 rounded-2xl shadow-2xl transform transition-all duration-300 z-50 flex items-center gap-3 font-bold border";

        if (type === 'success') {
          toast.classList.add('bg-emerald-950/80', 'border-emerald-800/60', 'text-emerald-100');
          toastIcon.className = "fa-solid fa-circle-check text-emerald-300";
        } else if (type === 'error') {
          toast.classList.add('bg-red-950/80', 'border-red-800/60', 'text-red-100');
          toastIcon.className = "fa-solid fa-triangle-exclamation text-red-300";
        } else if (type === 'copy') {
          toast.classList.add('bg-blue-950/80', 'border-blue-800/60', 'text-blue-100');
          toastIcon.className = "fa-solid fa-copy text-blue-300";
        } else {
          toast.classList.add('bg-slate-900/90', 'border-slate-700/70', 'text-white');
          toastIcon.className = "fa-solid fa-info-circle text-slate-200";
        }

        toast.classList.remove('translate-y-20', 'opacity-0');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 2300);
      }

      async function copyText(text) {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (_) {}
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.top = '-9999px';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        } catch (_) { return false; }
      }

      function safeJsonParse(value, fallback) { try { return JSON.parse(value); } catch { return fallback; } }
      function normalizeUrl(u){
        const url = String(u || '').trim();
        if(!url) return '';
        if (!/^https?:\/\//i.test(url)) return 'https://' + url;
        return url;
      }

      // =========================
      // âœ… Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø­ØªÙ‰ ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙŠØ¨Ø¯Ø£ ÙØ§Ø¶ÙŠ)
      // =========================
      const GO_ID = 'gemini';
      const NEW_GEMINI_ID = 'gemini_new';

      function defaultState(){
        return {
          inventoriesMeta: [
            { id:'main', name:'Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', type:'legacy-main' },
            { id:GO_ID, name:'Go', type:'legacy-gemini' },
            { id:NEW_GEMINI_ID, name:'Gemini', type:'custom' }
          ],
          activeInvId: 'main',
          store: {
            main: { inventory: [], pulledCounter: 0, currentAccount: null },
            gemini: { inventory: [], pulledCounter: 0, currentAccount: null },
            gemini_new: { inventory: [], pulledCounter: 0, currentAccount: null }
          },
          quickLinks: [
            { id:'l1', name:'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ChatGPT', url:'https://batch.1key.me/' },
            { id:'l2', name:'Ø¨ÙˆØª Ø§Ù„ØªØ­Ù‚Ù‚', url:'https://t.me/Veriyferbot' }
          ]
        };
      }

      // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªÙ†Ù…Ù„Ø£ Ù…Ù† default Ø£Ùˆ Ù…Ù† local Ø£Ùˆ Ù…Ù† cloud)
      let inventoriesMeta = defaultState().inventoriesMeta;
      let activeInvId = defaultState().activeInvId;
      let store = defaultState().store;
      let quickLinks = defaultState().quickLinks;

      function resetToDefaults(){
        const d = defaultState();
        inventoriesMeta = d.inventoriesMeta;
        activeInvId = d.activeInvId;
        store = d.store;
        quickLinks = d.quickLinks;
      }

      function S(){
        if(!store[activeInvId]) store[activeInvId] = { inventory: [], pulledCounter: 0, currentAccount: null };
        return store[activeInvId];
      }

      // =========================
      // âœ… Local Storage (Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…)
      // =========================
      const LOCAL_PREFIX = 'smartInv_local_v1_';
      function localKeyFor(uid){
        return LOCAL_PREFIX + String(uid || 'guest');
      }

      function buildState(mode='local'){
        return {
          v: 1,
          inventoriesMeta,
          activeInvId,
          store,
          quickLinks,
          updatedAt: (mode === 'cloud')
            ? firebase.firestore.FieldValue.serverTimestamp()
            : Date.now()
        };
      }

      function localSaveFor(uid){
        try{
          localStorage.setItem(localKeyFor(uid), JSON.stringify(buildState('local')));
        }catch(e){
          showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©).', 'error');
        }
      }

      function localLoadFor(uid){
        const key = localKeyFor(uid);
        const local = safeJsonParse(localStorage.getItem(key), null);
        if(local && typeof local === 'object'){
          applyAnyState(local);
          return true;
        }
        return false;
      }

      let localSaveTimer = null;
      function localSaveDebounced(uid){
        clearTimeout(localSaveTimer);
        localSaveTimer = setTimeout(() => {
          localSaveFor(uid);
        }, 200);
      }

      // =========================
      // âœ… Cloud Storage (Firestore) - Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
      // =========================
      let currentUser = null;
      let unsubRealtime = null;

      function userDocRef(uid){
        return db.collection('users').doc(uid).collection('smartInv').doc('state');
      }

      async function cloudSave(state){
        if(!currentUser) return;
        cloudStatus.textContent = 'ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸...';
        cloudStatus.className = 'font-bold text-amber-300';
        try{
          await userDocRef(currentUser.uid).set(state, { merge: true });
          cloudStatus.textContent = 'Ù…ØªØµÙ„ âœ…';
          cloudStatus.className = 'font-bold text-emerald-300';
        }catch(e){
          cloudStatus.textContent = 'ÙØ´Ù„ Ø§ØªØµØ§Ù„';
          cloudStatus.className = 'font-bold text-rose-300';
          showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Rules).', 'error');
        }
      }

      let saveTimer = null;
      function cloudSaveDebounced(){
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          cloudSave(buildState('cloud'));
        }, 700);
      }

      function persistDebounced(){
        const uid = currentUser ? currentUser.uid : 'guest';
        localSaveDebounced(uid);
        if(currentUser) cloudSaveDebounced();
      }

      function startRealtime(){
        if(!currentUser) return;
        if(unsubRealtime) unsubRealtime();

        unsubRealtime = userDocRef(currentUser.uid).onSnapshot((snap)=>{
          if(!snap.exists) return;
          const data = snap.data();
          applyAnyState(data);

          // Ù†Ø®Ø²Ù† Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·
          localSaveDebounced(currentUser.uid);

          cloudStatus.textContent = 'Ù…ØªØµÙ„ âœ…';
          cloudStatus.className = 'font-bold text-emerald-300';
        }, ()=>{
          cloudStatus.textContent = 'ÙØ´Ù„ Ø§ØªØµØ§Ù„';
          cloudStatus.className = 'font-bold text-rose-300';
        });
      }

      // =========================
      // âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© (Ø³ÙˆØ§Ø¡ Ù…Ù† Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø³Ø­Ø§Ø¨Ø©)
      // =========================
      function applyAnyState(state){
        if(!state) return;
        if(Array.isArray(state.inventoriesMeta)) inventoriesMeta = state.inventoriesMeta;
        if(typeof state.activeInvId === 'string') activeInvId = state.activeInvId;
        if(state.store && typeof state.store === 'object') store = state.store;
        if(Array.isArray(state.quickLinks)) quickLinks = state.quickLinks;

        buildTabs();
        setActiveInventory(activeInvId, true);
        renderLinks();
        renderSettingsInventories();
      }

      // =========================
      // UI
      // =========================
      function updateHeaderTitle(){
        titleNameEl.textContent = 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
      }

      function buildTabs(){
        tabsWrap.innerHTML = '';
        for (const inv of inventoriesMeta) {
          const btn = document.createElement('button');
          btn.className = "press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold text-slate-100";
          if (inv.id === activeInvId) btn.classList.add('tab-active');

          let icon = 'fa-layer-group';
          let iconColor = 'text-blue-300';
          if (inv.id === GO_ID) { icon = 'fa-bolt'; iconColor = 'text-emerald-300'; }
          if (inv.id === NEW_GEMINI_ID) { icon = 'fa-wand-magic-sparkles'; iconColor = 'text-sky-300'; }
          if (inv.id !== 'main' && inv.id !== GO_ID && inv.id !== NEW_GEMINI_ID) { icon = 'fa-box'; iconColor = 'text-amber-300'; }

          btn.innerHTML = `<i class="fa-solid ${icon} ml-2 ${iconColor}"></i>${inv.name}`;
          btn.addEventListener('click', () => setActiveInventory(inv.id));
          tabsWrap.appendChild(btn);
        }
      }

      function setStockCounterColor(stockLen) {
        if (stockLen === 0) stockCountEl.className = "text-2xl font-extrabold text-red-400";
        else if (stockLen < 5) stockCountEl.className = "text-2xl font-extrabold text-amber-300";
        else stockCountEl.className = "text-2xl font-extrabold text-emerald-300";
      }

      function displayResult(acc) {
        if (!acc) return;
        resultAreaEl.classList.remove('hidden');
        emailDisplayEl.textContent = acc.email || '---';
        passDisplayEl.textContent = acc.password || '---';
        recDisplayEl.textContent = acc.recovery || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        urlBtnEl.href = acc.url && acc.url !== '' ? acc.url : '#';
        timestampEl.textContent = new Date().toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      }

      function updateUI() {
        const s = S();
        stockCountEl.textContent = s.inventory.length;
        pulledCountEl.textContent = s.pulledCounter;
        setStockCounterColor(s.inventory.length);

        const last = s.currentAccount;
        if (last) displayResult(last);
        else resultAreaEl.classList.add('hidden');
      }

      function setActiveInventory(id, silent=false){
        if (!inventoriesMeta.some(x => x.id === id)) return;
        activeInvId = id;
        updateHeaderTitle();
        buildTabs();
        updateUI();
        renderMoveButtons();
        if(!silent) persistDebounced();
      }

      function createNewInventory(){
        flash(addInvBtn);
        const name = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
        if (!name || !String(name).trim()) { showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº).', 'error'); return; }
        const n = String(name).trim();
        if (inventoriesMeta.some(x => x.name === n)) { showToast('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø®ØªØ± Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù.', 'error'); return; }

        const id = 'inv_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,7);
        inventoriesMeta.push({ id, name: n, type:'custom' });
        store[id] = { inventory: [], pulledCounter: 0, currentAccount: null };

        buildTabs();
        setActiveInventory(id);
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø®Ø²ÙˆÙ† Ø¬Ø¯ÙŠØ¯ âœ…', 'success');
        persistDebounced();
      }

      function parseStandardLine(line) {
        const parts = line.split(';').map(p => p.trim());
        if (parts.length < 2) return { ok: false };
        const email = parts[0];
        const password = parts[1];
        const recovery = parts[2] || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
        const url = parts[3] || "#";
        if (!email || !password) return { ok: false };
        return { ok: true, acc: { email, password, recovery, url } };
      }

      function addToStockInternal(standardText) {
        const s = S();
        const stdLines = (standardText || '').replace(/\r/g, '').split('\n').map(l => l.trim()).filter(l => l.length >= 5);

        let addedCount = 0, duplicateCount = 0, invalidCount = 0;

        function existsEmail(email){ return s.inventory.some(a => a.email === email); }

        for (const line of stdLines) {
          const parsed = parseStandardLine(line);
          if (!parsed.ok) { invalidCount++; continue; }
          const acc = parsed.acc;
          if (existsEmail(acc.email)) { duplicateCount++; continue; }
          s.inventory.push(acc); addedCount++;
        }

        updateUI();
        persistDebounced();
        return { addedCount, duplicateCount, invalidCount };
      }

      function addToStock() {
        flash(addBtn);
        const standard = bulkInputEl.value;
        if (!standard.trim()) { showToast('Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±Øº!', 'error'); return; }
        const { addedCount, duplicateCount, invalidCount } = addToStockInternal(standard);
        bulkInputEl.value = '';

        const tabName = inventoriesMeta.find(x=>x.id===activeInvId)?.name || 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
        let msg = `(${tabName}) ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${addedCount} Ø­Ø³Ø§Ø¨.`;
        if (duplicateCount) msg += ` (Ù…ÙƒØ±Ø±: ${duplicateCount})`;
        if (invalidCount) msg += ` (ØºÙŠØ± ØµØ§Ù„Ø­: ${invalidCount})`;
        showToast(msg, addedCount ? 'success' : 'error');
      }

      function pullAccount() {
        flash(pullBtn);
        const s = S();
        if (s.inventory.length === 0) { showToast('Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº.', 'error'); return; }
        const acc = s.inventory.splice(0, 1)[0];
        s.currentAccount = acc;
        s.pulledCounter++;
        displayResult(acc);
        updateUI();
        persistDebounced();
        showToast('ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
      }

      function clearStorage() {
        flash(clearBtn);
        const tabName = inventoriesMeta.find(x=>x.id===activeInvId)?.name || 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø®Ø²ÙˆÙ† (${tabName}) Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ`)) return;

        const s = S();
        s.inventory = [];
        s.pulledCounter = 0;
        s.currentAccount = null;

        updateUI();
        persistDebounced();
        showToast('ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'success');
      }

      async function copyField(type) {
        const s = S();
        const acc = s.currentAccount;
        if (!acc) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù„Ù†Ø³Ø®.', 'error'); return; }
        let text = '', label = '';
        if (type === 'email') { text = acc.email; label = 'Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„'; }
        else if (type === 'password') { text = acc.password; label = 'Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯'; }
        else { text = acc.recovery; label = 'Ø§Ù„ØªØ­Ù‚Ù‚'; }
        const ok = await copyText(String(text || ''));
        showToast(ok ? `ØªÙ… Ù†Ø³Ø® ${label}` : 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', ok ? 'copy' : 'error');
      }

      async function copyFullCombo() {
        flash(copyFullBtn);
        const s = S();
        const acc = s.currentAccount;
        if (!acc) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.', 'error'); return; }

        const textToCopy =
          `Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„: ${acc.email}\n` +
          `Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯: ${acc.password}\n` +
          `Ø§Ù„ØªØ­Ù‚Ù‚: ${acc.recovery}\n` +
          `Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${acc.url || "#"}`;

        const ok = await copyText(textToCopy);
        showToast(ok ? 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§Ù…Ù„Ø©' : 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', ok ? 'success' : 'error');
      }

      function deleteLastPulled() {
        flash(deleteLastBtn);
        const s = S();
        if (!s.currentAccount) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨.', 'error'); return; }
        s.currentAccount = null;
        updateUI();
        persistDebounced();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©', 'success');
      }

      function restoreLastPulled() {
        flash(restoreBtn);
        const s = S();
        const acc = s.currentAccount;
        if (!acc) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.', 'error'); return; }
        if (!s.inventory.some(a => a.email === acc.email)) s.inventory.unshift(acc);
        if (s.pulledCounter > 0) s.pulledCounter--;
        s.currentAccount = null;
        updateUI();
        persistDebounced();
        showToast('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'success');
      }

      function moveAccountTo(targetInvId, targetLabel){
        if (activeInvId !== 'main') { showToast('Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ù‚Ù„ ØªØ¹Ù…Ù„ Ù…Ù† (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) ÙÙ‚Ø·.', 'error'); return; }
        const sMain = store['main'];
        const acc = sMain.currentAccount;
        if (!acc) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù„Ù†Ù‚Ù„.', 'error'); return; }

        if (!store[targetInvId]) store[targetInvId] = { inventory: [], pulledCounter: 0, currentAccount: null };
        const sTarget = store[targetInvId];

        if (sTarget.inventory.some(a => a.email === acc.email)) {
          showToast(`Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…Ø®Ø²ÙˆÙ† ${targetLabel}.`, 'error');
          return;
        }

        sTarget.inventory.unshift(acc);
        sMain.currentAccount = null;

        updateUI();
        persistDebounced();
        showToast(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ù„Ù‰ Ù…Ø®Ø²ÙˆÙ† ${targetLabel}`, 'success');
      }

      function renderMoveButtons(){
        moveButtonsWrap.innerHTML = '';
        if (activeInvId !== 'main') return;

        const targets = inventoriesMeta.filter(x => x.id !== 'main');
        if (!targets.length) return;

        for (const t of targets) {
          const btn = document.createElement('button');
          btn.className = "press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2";
          btn.innerHTML = `<i class="fa-solid fa-right-left text-slate-200"></i><span>Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ${t.name}</span>`;
          btn.addEventListener('click', () => moveAccountTo(t.id, t.name));
          moveButtonsWrap.appendChild(btn);
        }
      }

      async function importTxtFile(file) {
        if (!file) return;
        flash(importBtn);
        if (!file.name.toLowerCase().endsWith('.txt')) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù TXT ÙÙ‚Ø·', 'error'); return; }
        try {
          const content = await file.text();
          const { addedCount, duplicateCount, invalidCount } = addToStockInternal(content);
          let msg = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: +${addedCount}`;
          if (duplicateCount) msg += ` (Ù…ÙƒØ±Ø±: ${duplicateCount})`;
          if (invalidCount) msg += ` (ØºÙŠØ± ØµØ§Ù„Ø­: ${invalidCount})`;
          showToast(msg, addedCount ? 'success' : 'error');
        } catch (e) { showToast('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error'); }
      }

      function exportStockToTxt() {
        flash(exportBtn);
        const s = S();
        if (!s.inventory.length) { showToast('Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº.', 'error'); return; }
        const content = s.inventory.map(acc => `${acc.email};${acc.password};${acc.recovery};${acc.url}`).join('\n');
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const meta = inventoriesMeta.find(x=>x.id===activeInvId);
        const safeName = (meta?.name || 'inventory').replace(/[^\w\u0600-\u06FF]+/g,'_');

        const a = document.createElement('a');
        a.href = url;
        a.download = `${safeName}_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${s.inventory.length} Ø­Ø³Ø§Ø¨`, 'success');
      }

      // Settings modal
      function openSettings(){
        flash(settingsBtn);
        renderSettingsInventories();
        settingsModal.classList.add('show');
        document.body.classList.add('modal-open');
      }
      function closeSettings(){
        settingsModal.classList.remove('show');
        document.body.classList.remove('modal-open');
      }

      function deleteInventory(invId){
        const meta = inventoriesMeta.find(x=>x.id===invId);
        if (!meta) return;
        if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù…Ø®Ø²ÙˆÙ†: (${meta.name}) Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŸ`)) return;

        delete store[invId];
        inventoriesMeta = inventoriesMeta.filter(x => x.id !== invId);

        if (activeInvId === invId) activeInvId = 'main';

        buildTabs();
        setActiveInventory(activeInvId);
        renderSettingsInventories();
        persistDebounced();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ† âœ…', 'success');
      }

      function renderSettingsInventories(){
        invListWrap.innerHTML = '';
        for (const inv of inventoriesMeta) {
          const row = document.createElement('div');
          row.className = "flex flex-col md:flex-row gap-2 md:items-center md:justify-between bg-slate-950/25 border border-slate-700/40 rounded-2xl p-3";

          const left = document.createElement('div');
          left.className = "text-sm text-slate-100";
          left.innerHTML = `<div class="font-extrabold">${inv.name}</div><div class="text-xs text-slate-300">ID: ${inv.id}</div>`;

          const right = document.createElement('div');
          right.className = "flex gap-2";

          const switchBtn = document.createElement('button');
          switchBtn.className = "press-glow soft bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-4 py-2 rounded-2xl text-sm";
          switchBtn.innerHTML = `<i class="fa-solid fa-arrow-right-arrow-left ml-2 text-slate-200"></i>ÙØªØ­`;
          switchBtn.addEventListener('click', () => { setActiveInventory(inv.id); closeSettings(); });

          const delBtn = document.createElement('button');
          delBtn.className = "press-glow soft bg-red-700/20 hover:bg-red-700/28 border border-red-700/30 text-red-100 font-bold px-4 py-2 rounded-2xl text-sm";
          delBtn.innerHTML = `<i class="fa-solid fa-trash ml-2 text-red-300"></i>Ø­Ø°Ù`;
          delBtn.addEventListener('click', () => deleteInventory(inv.id));

          right.appendChild(switchBtn);
          right.appendChild(delBtn);

          row.appendChild(left);
          row.appendChild(right);
          invListWrap.appendChild(row);
        }
      }

      // Links
      function openLinks(){
        flash(linksBtn);
        renderLinks();
        linksModal.classList.add('show');
        document.body.classList.add('modal-open');
      }
      function closeLinks(){
        linksModal.classList.remove('show');
        document.body.classList.remove('modal-open');
      }

      function swapLinks(i, j){
        if (i < 0 || j < 0) return;
        if (i >= quickLinks.length || j >= quickLinks.length) return;
        const tmp = quickLinks[i];
        quickLinks[i] = quickLinks[j];
        quickLinks[j] = tmp;
        persistDebounced();
        renderLinks();
      }

      function removeLinkById(id){
        const item = quickLinks.find(x => x.id === id);
        if (!item) return;
        if (!confirm(`Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø·: ${item.name} ØŸ`)) return;
        quickLinks = quickLinks.filter(x => x.id !== id);
        persistDebounced();
        renderLinks();
        showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø·', 'success');
      }

      function renderLinks(){
        linksWrap.innerHTML = '';

        for (let idx = 0; idx < quickLinks.length; idx++) {
          const item = quickLinks[idx];

          const row = document.createElement('div');
          row.className = "bg-slate-950/20 border border-slate-700/40 rounded-2xl p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3";

          const left = document.createElement('button');
          left.className = "min-w-0 text-right flex-1";
          left.innerHTML = `
            <div class="font-extrabold text-white truncate hover:underline" title="Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®">${item.name || 'Ø±Ø§Ø¨Ø·'}</div>
            <div class="text-xs text-slate-300 mt-1 break-words">${item.url || ''}</div>
          `;
          left.addEventListener('click', async () => {
            const ok = await copyText(String(item.url || ''));
            showToast(ok ? 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·' : 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', ok ? 'copy' : 'error');
          });

          const right = document.createElement('div');
          right.className = "flex gap-2 flex-shrink-0 flex-wrap justify-start sm:justify-end";

          const upBtn = document.createElement('button');
          upBtn.className = "press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-3 py-2 rounded-2xl text-sm";
          upBtn.textContent = 'â†‘';
          upBtn.disabled = idx === 0;
          upBtn.style.opacity = idx === 0 ? '.45' : '1';
          upBtn.addEventListener('click', () => swapLinks(idx, idx - 1));

          const downBtn = document.createElement('button');
          downBtn.className = "press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-3 py-2 rounded-2xl text-sm";
          downBtn.textContent = 'â†“';
          downBtn.disabled = idx === quickLinks.length - 1;
          downBtn.style.opacity = idx === quickLinks.length - 1 ? '.45' : '1';
          downBtn.addEventListener('click', () => swapLinks(idx, idx + 1));

          const openBtn = document.createElement('button');
          openBtn.className = "press-glow soft bg-emerald-700/20 hover:bg-emerald-700/28 border border-emerald-700/30 text-emerald-100 font-bold px-4 py-2 rounded-2xl text-sm";
          openBtn.textContent = 'ÙØªØ­';
          openBtn.addEventListener('click', () => {
            const u = item.url || '';
            if(!u) return;
            window.open(u, '_blank', 'noopener');
          });

          const removeBtn = document.createElement('button');
          removeBtn.className = "press-glow soft bg-red-700/20 hover:bg-red-700/28 border border-red-700/30 text-red-100 font-bold px-4 py-2 rounded-2xl text-sm";
          removeBtn.textContent = 'Ø¥Ø²Ø§Ù„Ø©';
          removeBtn.addEventListener('click', () => removeLinkById(item.id));

          right.appendChild(upBtn);
          right.appendChild(downBtn);
          right.appendChild(openBtn);
          right.appendChild(removeBtn);

          row.appendChild(left);
          row.appendChild(right);
          linksWrap.appendChild(row);
        }
      }

      function addLink(){
        flash(addLinkBtn);
        const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø±Ø§Ø¨Ø·:');
        if (!name || !String(name).trim()) { showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ù„Ø§Ø³Ù… ÙØ§Ø±Øº).', 'error'); return; }
        const urlIn = prompt('Ø§Ù„Ø±Ø§Ø¨Ø·:');
        if (!urlIn || !String(urlIn).trim()) { showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ù„Ø±Ø§Ø¨Ø· ÙØ§Ø±Øº).', 'error'); return; }
        const url = normalizeUrl(urlIn);
        if (!url) { showToast('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­.', 'error'); return; }

        const id = 'l_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6);
        quickLinks.push({ id, name: String(name).trim(), url });
        persistDebounced();
        renderLinks();
        showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· âœ…', 'success');
      }

      // Events
      toggleBtn.addEventListener('click', () => { flash(toggleBtn); inputSectionEl.classList.toggle('hidden'); });
      clearBtn.addEventListener('click', clearStorage);
      addBtn.addEventListener('click', addToStock);
      pullBtn.addEventListener('click', pullAccount);
      copyFullBtn.addEventListener('click', copyFullCombo);

      restoreBtn.addEventListener('click', restoreLastPulled);
      deleteLastBtn.addEventListener('click', deleteLastPulled);

      importBtn.addEventListener('click', () => { flash(importBtn); importFile.click(); });
      importFile.addEventListener('change', async () => {
        const file = importFile.files && importFile.files[0] ? importFile.files[0] : null;
        await importTxtFile(file);
        importFile.value = '';
      });

      exportBtn.addEventListener('click', exportStockToTxt);

      document.querySelectorAll('[data-copy]').forEach(card => {
        card.addEventListener('click', () => { flash(card); copyField(card.getAttribute('data-copy')); });
      });

      addInvBtn.addEventListener('click', createNewInventory);

      settingsBtn.addEventListener('click', openSettings);
      closeSettingsBtn.addEventListener('click', closeSettings);
      settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });

      linksBtn.addEventListener('click', openLinks);
      closeLinksBtn.addEventListener('click', closeLinks);
      addLinkBtn.addEventListener('click', addLink);
      linksModal.addEventListener('click', (e) => { if (e.target === linksModal) closeLinks(); });

      // Auth buttons
      registerBtn.addEventListener('click', async () => {
        const em = String(authEmail.value||'').trim();
        const pw = String(authPass.value||'').trim();
        if(!em || !pw){ showToast('Ø§ÙƒØªØ¨ Ø§ÙŠÙ…ÙŠÙ„ ÙˆØ¨Ø§Ø³ÙˆØ±Ø¯', 'error'); return; }
        try{
          await auth.createUserWithEmailAndPassword(em, pw);
          showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…', 'success');
        }catch(e){
          showToast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯)', 'error');
        }
      });

      loginBtn.addEventListener('click', async () => {
        const em = String(authEmail.value||'').trim();
        const pw = String(authPass.value||'').trim();
        if(!em || !pw){ showToast('Ø§ÙƒØªØ¨ Ø§ÙŠÙ…ÙŠÙ„ ÙˆØ¨Ø§Ø³ÙˆØ±Ø¯', 'error'); return; }
        try{
          await auth.signInWithEmailAndPassword(em, pw);
          showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…', 'success');
        }catch(e){
          showToast('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)', 'error');
        }
      });

      logoutBtn.addEventListener('click', async () => {
        try{
          await auth.signOut();
          showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'success');
        }catch(e){
          showToast('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'error');
        }
      });

      function openAuth(){
        authModal.classList.add('show');
        document.body.classList.add('modal-open');
      }
      function closeAuth(){
        authModal.classList.remove('show');
        document.body.classList.remove('modal-open');
      }

      // âœ… Ù…Ù‡Ù…: Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ù„ÙŠ Ø¹Ø§Ù…)
      updateHeaderTitle();
      buildTabs();
      updateUI();
      renderMoveButtons();

      // Init + Auth state
      auth.onAuthStateChanged(async (user) => {
        currentUser = user || null;

        if(!currentUser){
          userLabel.textContent = '---';
          cloudStatus.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
          cloudStatus.className = 'font-bold text-amber-300';

          // Ù†ÙØ±Ù‘Øº Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ùˆ ÙƒØ§Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø§Ø¨Ù‚ Ø­ØªÙ‰ Ù…Ø§ ÙŠØµÙŠØ± Ø®Ù„Ø·
          resetToDefaults();
          updateHeaderTitle();
          buildTabs();
          updateUI();
          renderMoveButtons();

          openAuth();
          return;
        }

        // logged in
        userLabel.textContent = (currentUser.email || currentUser.uid).slice(0, 32);
        closeAuth();

        // 1) Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· (Ø³Ø±ÙŠØ¹)
        const hasLocal = localLoadFor(currentUser.uid);
        if(hasLocal){
          buildTabs();
          setActiveInventory(activeInvId, true);
          updateUI();
          renderMoveButtons();
        }

        // 2) Ø«Ù… Ø§Ù‚Ø±Ø£ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ø§Ù„Ø£ØµØ­)
        try{
          const snap = await userDocRef(currentUser.uid).get();

          if(!snap.exists){
            // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: Ù„Ø§ Ù†Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª "ØºÙŠØ±Ù‡"
            // Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ù‡ Ù…Ø­Ù„ÙŠ Ø®Ø§Øµ Ø¨Ù‡ (Ù‚Ø¯ÙŠÙ…Ø©) Ù†Ø®Ø²Ù†Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø®Ø²Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            if(!hasLocal){
              resetToDefaults();
            }
            await cloudSave(buildState('cloud'));
            localSaveDebounced(currentUser.uid);
          }else{
            applyAnyState(snap.data());
            localSaveDebounced(currentUser.uid);
          }
        }catch(e){
          showToast('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Rules)', 'error');
        }

        startRealtime();
        buildTabs();
        setActiveInventory(activeInvId, true);
        updateUI();
        renderMoveButtons();
      });

      // ===== Snow =====
      const canvas = document.getElementById('snowCanvas');
      const ctx = canvas.getContext('2d', { alpha: true });
      let W = 0, H = 0;

      function resize(){
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize, { passive:true });
      resize();

      const flakes = Array.from({ length: 55 }, () => ({
        x: Math.random()*W,
        y: Math.random()*H,
        r: 0.6 + Math.random()*1.6,
        v: 0.25 + Math.random()*0.9,
        drift: (Math.random()*0.6) - 0.3,
        a: 0.12 + Math.random()*0.20
      }));

      function snowTick(){
        ctx.clearRect(0,0,W,H);
        for(const f of flakes){
          f.y += f.v;
          f.x += f.drift;

          if (f.y > H + 5) { f.y = -5; f.x = Math.random()*W; }
          if (f.x > W + 5) f.x = -5;
          if (f.x < -5) f.x = W + 5;

          ctx.beginPath();
          ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
          ctx.closePath();
          ctx.fillStyle = `rgba(255,255,255,${f.a})`;
          ctx.fill();
        }
        requestAnimationFrame(snowTick);
      }
      snowTick();
    })();
  </script>
</body>
</html>
